{"version":3,"file":"KHR_draco_mesh_compression-CSjKQm0S.js","sources":["../../node_modules/@babylonjs/loaders/glTF/2.0/Extensions/KHR_draco_mesh_compression.js"],"sourcesContent":["import { DracoDecoder } from \"@babylonjs/core/Meshes/Compression/dracoDecoder.js\";\nimport { VertexBuffer } from \"@babylonjs/core/Buffers/buffer.js\";\nimport { GLTFLoader, ArrayItem, LoadBoundingInfoFromPositionAccessor } from \"../glTFLoader.js\";\nimport { registerGLTFExtension, unregisterGLTFExtension } from \"../glTFLoaderExtensionRegistry.js\";\nconst NAME = \"KHR_draco_mesh_compression\";\n/**\n * [Specification](https://github.com/KhronosGroup/glTF/blob/main/extensions/2.0/Khronos/KHR_draco_mesh_compression/README.md)\n */\n// eslint-disable-next-line @typescript-eslint/naming-convention\nexport class KHR_draco_mesh_compression {\n    /**\n     * @internal\n     */\n    constructor(loader) {\n        /**\n         * The name of this extension.\n         */\n        this.name = NAME;\n        /**\n         * Defines whether to use the normalized flag from the glTF accessor instead of the Draco data. Defaults to true.\n         */\n        this.useNormalizedFlagFromAccessor = true;\n        this._loader = loader;\n        this.enabled = DracoDecoder.DefaultAvailable && this._loader.isExtensionUsed(NAME);\n    }\n    /** @internal */\n    dispose() {\n        delete this.dracoDecoder;\n        this._loader = null;\n    }\n    /**\n     * @internal\n     */\n    _loadVertexDataAsync(context, primitive, babylonMesh) {\n        return GLTFLoader.LoadExtensionAsync(context, primitive, this.name, (extensionContext, extension) => {\n            if (primitive.mode != undefined) {\n                if (primitive.mode !== 4 /* MeshPrimitiveMode.TRIANGLES */ && primitive.mode !== 5 /* MeshPrimitiveMode.TRIANGLE_STRIP */) {\n                    throw new Error(`${context}: Unsupported mode ${primitive.mode}`);\n                }\n            }\n            const attributes = {};\n            const normalized = {};\n            const loadAttribute = (name, kind) => {\n                const uniqueId = extension.attributes[name];\n                if (uniqueId == undefined) {\n                    return;\n                }\n                babylonMesh._delayInfo = babylonMesh._delayInfo || [];\n                if (babylonMesh._delayInfo.indexOf(kind) === -1) {\n                    babylonMesh._delayInfo.push(kind);\n                }\n                attributes[kind] = uniqueId;\n                if (this.useNormalizedFlagFromAccessor) {\n                    const accessor = ArrayItem.TryGet(this._loader.gltf.accessors, primitive.attributes[name]);\n                    if (accessor) {\n                        normalized[kind] = accessor.normalized || false;\n                    }\n                }\n            };\n            loadAttribute(\"POSITION\", VertexBuffer.PositionKind);\n            loadAttribute(\"NORMAL\", VertexBuffer.NormalKind);\n            loadAttribute(\"TANGENT\", VertexBuffer.TangentKind);\n            loadAttribute(\"TEXCOORD_0\", VertexBuffer.UVKind);\n            loadAttribute(\"TEXCOORD_1\", VertexBuffer.UV2Kind);\n            loadAttribute(\"TEXCOORD_2\", VertexBuffer.UV3Kind);\n            loadAttribute(\"TEXCOORD_3\", VertexBuffer.UV4Kind);\n            loadAttribute(\"TEXCOORD_4\", VertexBuffer.UV5Kind);\n            loadAttribute(\"TEXCOORD_5\", VertexBuffer.UV6Kind);\n            loadAttribute(\"JOINTS_0\", VertexBuffer.MatricesIndicesKind);\n            loadAttribute(\"WEIGHTS_0\", VertexBuffer.MatricesWeightsKind);\n            loadAttribute(\"COLOR_0\", VertexBuffer.ColorKind);\n            const bufferView = ArrayItem.Get(extensionContext, this._loader.gltf.bufferViews, extension.bufferView);\n            if (!bufferView._dracoBabylonGeometry) {\n                bufferView._dracoBabylonGeometry = this._loader.loadBufferViewAsync(`/bufferViews/${bufferView.index}`, bufferView).then((data) => {\n                    const dracoDecoder = this.dracoDecoder || DracoDecoder.Default;\n                    const positionAccessor = ArrayItem.TryGet(this._loader.gltf.accessors, primitive.attributes[\"POSITION\"]);\n                    const babylonBoundingInfo = !this._loader.parent.alwaysComputeBoundingBox && !babylonMesh.skeleton && positionAccessor ? LoadBoundingInfoFromPositionAccessor(positionAccessor) : null;\n                    return dracoDecoder\n                        ._decodeMeshToGeometryForGltfAsync(babylonMesh.name, this._loader.babylonScene, data, attributes, normalized, babylonBoundingInfo)\n                        .catch((error) => {\n                        throw new Error(`${context}: ${error.message}`);\n                    });\n                });\n            }\n            return bufferView._dracoBabylonGeometry;\n        });\n    }\n}\nunregisterGLTFExtension(NAME);\nregisterGLTFExtension(NAME, true, (loader) => new KHR_draco_mesh_compression(loader));\n//# sourceMappingURL=KHR_draco_mesh_compression.js.map"],"names":["NAME","KHR_draco_mesh_compression","loader","DracoDecoder","context","primitive","babylonMesh","GLTFLoader","extensionContext","extension","attributes","normalized","loadAttribute","name","kind","uniqueId","accessor","ArrayItem","VertexBuffer","bufferView","data","dracoDecoder","positionAccessor","babylonBoundingInfo","LoadBoundingInfoFromPositionAccessor","error","unregisterGLTFExtension","registerGLTFExtension"],"mappings":"mKAIA,MAAMA,EAAO,6BAKN,MAAMC,CAA2B,CAIpC,YAAYC,EAAQ,CAIhB,KAAK,KAAOF,EAIZ,KAAK,8BAAgC,GACrC,KAAK,QAAUE,EACf,KAAK,QAAUC,EAAa,kBAAoB,KAAK,QAAQ,gBAAgBH,CAAI,CACzF,CAEI,SAAU,CACN,OAAO,KAAK,aACZ,KAAK,QAAU,IACvB,CAII,qBAAqBI,EAASC,EAAWC,EAAa,CAClD,OAAOC,EAAW,mBAAmBH,EAASC,EAAW,KAAK,KAAM,CAACG,EAAkBC,IAAc,CACjG,GAAIJ,EAAU,MAAQ,MACdA,EAAU,OAAS,GAAuCA,EAAU,OAAS,EAC7E,MAAM,IAAI,MAAM,GAAGD,CAAO,sBAAsBC,EAAU,IAAI,EAAE,EAGxE,MAAMK,EAAa,CAAE,EACfC,EAAa,CAAE,EACfC,EAAgB,CAACC,EAAMC,IAAS,CAClC,MAAMC,EAAWN,EAAU,WAAWI,CAAI,EAC1C,GAAIE,GAAY,OAGhBT,EAAY,WAAaA,EAAY,YAAc,CAAE,EACjDA,EAAY,WAAW,QAAQQ,CAAI,IAAM,IACzCR,EAAY,WAAW,KAAKQ,CAAI,EAEpCJ,EAAWI,CAAI,EAAIC,EACf,KAAK,+BAA+B,CACpC,MAAMC,EAAWC,EAAU,OAAO,KAAK,QAAQ,KAAK,UAAWZ,EAAU,WAAWQ,CAAI,CAAC,EACrFG,IACAL,EAAWG,CAAI,EAAIE,EAAS,YAAc,GAElE,CACa,EACDJ,EAAc,WAAYM,EAAa,YAAY,EACnDN,EAAc,SAAUM,EAAa,UAAU,EAC/CN,EAAc,UAAWM,EAAa,WAAW,EACjDN,EAAc,aAAcM,EAAa,MAAM,EAC/CN,EAAc,aAAcM,EAAa,OAAO,EAChDN,EAAc,aAAcM,EAAa,OAAO,EAChDN,EAAc,aAAcM,EAAa,OAAO,EAChDN,EAAc,aAAcM,EAAa,OAAO,EAChDN,EAAc,aAAcM,EAAa,OAAO,EAChDN,EAAc,WAAYM,EAAa,mBAAmB,EAC1DN,EAAc,YAAaM,EAAa,mBAAmB,EAC3DN,EAAc,UAAWM,EAAa,SAAS,EAC/C,MAAMC,EAAaF,EAAU,IAAIT,EAAkB,KAAK,QAAQ,KAAK,YAAaC,EAAU,UAAU,EACtG,OAAKU,EAAW,wBACZA,EAAW,sBAAwB,KAAK,QAAQ,oBAAoB,gBAAgBA,EAAW,KAAK,GAAIA,CAAU,EAAE,KAAMC,GAAS,CAC/H,MAAMC,EAAe,KAAK,cAAgBlB,EAAa,QACjDmB,EAAmBL,EAAU,OAAO,KAAK,QAAQ,KAAK,UAAWZ,EAAU,WAAW,QAAW,EACjGkB,EAAsB,CAAC,KAAK,QAAQ,OAAO,0BAA4B,CAACjB,EAAY,UAAYgB,EAAmBE,EAAqCF,CAAgB,EAAI,KAClL,OAAOD,EACF,kCAAkCf,EAAY,KAAM,KAAK,QAAQ,aAAcc,EAAMV,EAAYC,EAAYY,CAAmB,EAChI,MAAOE,GAAU,CAClB,MAAM,IAAI,MAAM,GAAGrB,CAAO,KAAKqB,EAAM,OAAO,EAAE,CACtE,CAAqB,CACrB,CAAiB,GAEEN,EAAW,qBAC9B,CAAS,CACT,CACA,CACAO,EAAwB1B,CAAI,EAC5B2B,EAAsB3B,EAAM,GAAOE,GAAW,IAAID,EAA2BC,CAAM,CAAC","x_google_ignoreList":[0]}